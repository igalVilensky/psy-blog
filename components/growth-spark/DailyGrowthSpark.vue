<template>
  <Teleport to="body">
    <div
      v-if="isVisible"
      class="fixed inset-0 bg-black/80 flex justify-center items-start md:items-center z-[999] backdrop-blur-sm overflow-y-auto"
      @click="handleOverlayClick"
    >
      <div
        class="bg-gray-900 rounded-2xl w-[95%] max-w-[500px] flex flex-col shadow-2xl overflow-hidden animate-fade-in-up my-4 border border-gray-700 text-gray-100"
        @click.stop
      >
        <!-- Modal header with progress indicator -->
        <div class="p-4 border-b border-gray-800 relative">
          <h2 class="text-xl font-semibold text-gray-100">
            Ежедневная искра роста
          </h2>
          <div class="mt-3">
            <div class="flex justify-between mb-2">
              <div
                v-for="(step, index) in [
                  'Эмоциональная проницательность',
                  'Проверка энергии',
                  'Поделитесь открытием',
                ]"
                :key="index"
                :class="[
                  'flex flex-col items-center flex-1',
                  getStageIndex(currentStage) === index ? 'text-blue-400' : '',
                  getStageIndex(currentStage) > index ? 'text-green-400' : '',
                ]"
              >
                <div
                  :class="[
                    'w-6 h-6 rounded-full flex items-center justify-center text-xs font-semibold mb-1 transition-all',
                    getStageIndex(currentStage) === index
                      ? 'bg-blue-500 text-gray-900'
                      : getStageIndex(currentStage) > index
                      ? 'bg-green-500 text-gray-900'
                      : 'bg-gray-700 text-gray-300',
                  ]"
                >
                  {{ index + 1 }}
                </div>
                <div class="text-xs hidden sm:block">{{ step }}</div>
                <div class="text-xs sm:hidden">
                  {{
                    index === 0 ? "Эмоция" : index === 1 ? "Энергия" : "Совет"
                  }}
                </div>
              </div>
            </div>
            <div class="h-1.5 bg-gray-700 rounded-full relative">
              <div
                class="absolute top-0 left-0 h-full bg-gradient-to-r from-blue-600 to-blue-400 rounded-full transition-all"
                :style="`width: ${progressPercentage}%`"
              ></div>
            </div>
          </div>
          <div
            class="absolute top-4 right-12 text-sm text-gray-300 flex items-center"
          >
            <i class="fas fa-star text-yellow-400 mr-1"></i>
            <span>{{ points }}</span>
          </div>
          <button
            class="absolute right-4 top-4 text-gray-400 hover:text-gray-200 hover:bg-gray-700 w-8 h-8 flex items-center justify-center rounded-full transition-all"
            @click="confirmClose"
            aria-label="Закрыть"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="p-4 overflow-y-auto max-h-[70vh]">
          <!-- Stage 1: Emotion Insight Game -->
          <div v-if="currentStage === 'emotion'" class="space-y-4">
            <div class="flex justify-between items-center">
              <h3 class="text-base font-medium text-gray-100">
                Эмоциональная проницательность
              </h3>
              <div class="flex gap-1">
                <div
                  v-for="i in 3"
                  :key="i"
                  class="text-lg transition-all"
                  :class="{
                    'opacity-30': winCount < i,
                    'scale-110': winCount >= i,
                  }"
                >
                  <i class="fas fa-star text-yellow-400"></i>
                </div>
              </div>
            </div>
            <div class="bg-gray-800 p-3 rounded-xl border border-gray-700">
              <p class="text-gray-300 italic text-sm mb-2">
                {{ currentScenario.prompt }}
              </p>
              <div class="text-xs text-blue-400 font-medium">
                Связано с {{ currentScenario.sefira }}:
                {{ currentScenario.sefiraDescription }}
              </div>
            </div>
            <div class="flex justify-center gap-3 flex-wrap">
              <div
                v-for="(emotion, index) in currentScenario.emotions"
                :key="index"
                @click="handleEmotionClick(index)"
                :class="[
                  'w-20 h-16 flex flex-col items-center justify-center rounded-xl cursor-pointer transition-all border-2 p-1',
                  selectedIndex === index
                    ? 'border-blue-500 bg-blue-900/50'
                    : 'border-transparent bg-gray-800',
                  isCorrect && selectedIndex === index
                    ? 'bg-green-900/40 border-green-500 scale-105'
                    : '',
                  isWrong && selectedIndex === index
                    ? 'bg-red-900/40 border-red-500 animate-shake'
                    : '',
                  'hover:-translate-y-1 hover:shadow-md hover:shadow-blue-900/30',
                ]"
              >
                <span class="text-xl">{{ emotion.emoji }}</span>
                <span
                  :class="[
                    'text-xs mt-1 text-center',
                    selectedIndex === index
                      ? 'text-gray-200 font-medium'
                      : 'text-gray-400',
                  ]"
                >
                  {{ emotion.label }}
                </span>
              </div>
            </div>
            <div
              v-if="feedback"
              :class="[
                'p-2 rounded-lg text-center font-medium text-sm',
                isCorrect
                  ? 'bg-green-900/30 text-green-400 border border-green-700'
                  : 'bg-red-900/30 text-red-400 border border-red-700',
              ]"
            >
              {{ feedback }}
            </div>
            <button
              v-if="gameComplete"
              @click="nextRound"
              class="bg-blue-600 text-gray-100 px-4 py-2 rounded-lg font-medium hover:bg-blue-500 transition-all hover:-translate-y-1 mx-auto block text-sm"
            >
              {{ winCount >= 3 ? "Продолжить" : "Следующий вопрос" }}
            </button>
          </div>

          <!-- Stage 2: Energy Tracker -->
          <div v-if="currentStage === 'energy'" class="text-center space-y-4">
            <h3 class="text-base font-medium text-gray-100">
              Как ваша энергия сегодня?
            </h3>
            <div>
              <div class="text-4xl mb-2 transition-all">{{ energyEmoji }}</div>
              <div class="text-base font-medium text-gray-300">
                {{ energyLevel }} - {{ energyFeedback }}
              </div>
            </div>
            <div class="flex items-center px-2">
              <span class="text-xs text-gray-400 w-8 text-right">Низкая</span>
              <input
                type="range"
                v-model="energyLevel"
                min="0"
                max="10"
                step="1"
                class="flex-1 h-2 mx-2 rounded-full appearance-none bg-gradient-to-r from-red-500 via-yellow-500 to-green-500"
              />
              <span class="text-xs text-gray-400 w-8 text-left">Высокая</span>
            </div>
            <div class="bg-gray-800 p-3 rounded-xl border border-gray-700">
              <h4 class="text-sm font-medium mb-2 text-gray-200">
                Топливо для роста
              </h4>
              <div class="flex flex-wrap justify-center gap-2">
                <div
                  v-for="(item, index) in growthFuelItems"
                  :key="index"
                  :class="[
                    'flex flex-col items-center p-2 w-16 rounded-lg cursor-pointer transition-all border',
                    item.selected
                      ? 'bg-blue-600 text-gray-100 border-blue-400'
                      : 'bg-gray-700 text-gray-300 border-gray-600 hover:bg-gray-600',
                  ]"
                  @click="toggleFuelItem(index)"
                >
                  <i :class="['fas', item.icon, 'text-lg mb-1']"></i>
                  <span class="text-xs text-center">{{ item.label }}</span>
                </div>
              </div>
            </div>
            <button
              @click="submitEnergy"
              class="bg-blue-600 text-gray-100 px-4 py-2 rounded-lg font-medium hover:bg-blue-500 transition-all hover:-translate-y-1 text-sm"
            >
              Продолжить
            </button>
          </div>

          <!-- Stage 3: Tip Input -->
          <div v-if="currentStage === 'tip'" class="text-center space-y-4">
            <h3 class="text-base font-medium text-gray-100">
              Поделитесь своим открытием
            </h3>
            <p class="text-gray-400 text-sm">
              Что помогло вам вырасти? Поделитесь, чтобы вдохновить других.
            </p>
            <div class="flex flex-wrap justify-center gap-2">
              <span
                v-for="(category, index) in tipCategories"
                :key="index"
                :class="[
                  'px-3 py-1.5 rounded-full text-xs cursor-pointer transition-all',
                  selectedCategory === category
                    ? 'bg-blue-600 text-gray-100 border border-blue-400'
                    : 'bg-gray-700 text-gray-300 hover:bg-gray-600 border border-gray-600',
                ]"
                @click="selectedCategory = category"
              >
                {{ category }}
              </span>
            </div>
            <div class="relative">
              <textarea
                v-model="tip"
                placeholder="Введите совет, открытие или напоминание..."
                rows="3"
                maxlength="280"
                class="w-full p-3 border border-gray-700 rounded-lg resize-none focus:border-blue-500 focus:ring-2 focus:ring-blue-700 transition-all text-sm bg-gray-800 text-gray-200 placeholder-gray-500"
              ></textarea>
              <div class="absolute bottom-2 right-3 text-xs text-gray-500">
                {{ tip.length }}/280
              </div>
            </div>
            <div
              class="flex items-center justify-center gap-2 text-xs text-gray-400"
            >
              <label class="relative inline-block w-10 h-5">
                <input
                  type="checkbox"
                  v-model="isAnonymous"
                  class="opacity-0 w-0 h-0"
                />
                <span
                  class="absolute inset-0 cursor-pointer bg-gray-700 rounded-full transition-all before:absolute before:h-4 before:w-4 before:left-0.5 before:bottom-0.5 before:bg-gray-300 before:rounded-full before:transition-all"
                  :class="{ 'bg-blue-600 before:translate-x-5': isAnonymous }"
                ></span>
              </label>
              <span>Поделиться анонимно</span>
            </div>
            <div class="flex justify-center gap-3">
              <button
                @click="skipTip"
                class="bg-gray-700 text-gray-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-600 transition-all text-sm"
              >
                Пропустить
              </button>
              <button
                @click="submitTip"
                class="bg-blue-600 text-gray-100 px-4 py-2 rounded-lg font-medium transition-all hover:bg-blue-500 hover:-translate-y-1 text-sm"
                :class="{
                  'bg-gray-600 cursor-not-allowed hover:bg-gray-600 hover:translate-y-0':
                    tip.trim() === '',
                }"
                :disabled="tip.trim() === ''"
              >
                Отправить
              </button>
            </div>
          </div>

          <!-- Final Stage: Success -->
          <div
            v-if="currentStage === 'success'"
            class="text-center space-y-4 py-3"
          >
            <div class="text-4xl animate-bounce-in">
              <i class="fas fa-check-circle text-green-500"></i>
            </div>
            <h3 class="text-base font-medium text-gray-100">
              Отличная работа!
            </h3>
            <p class="text-sm text-gray-300">
              Вы завершили сегодняшнюю искру роста. Возвращайтесь завтра за
              новым вызовом!
            </p>
            <div class="bg-gray-800 p-3 rounded-xl border border-gray-700">
              <p class="text-gray-300 text-sm">
                Сегодня вы: {{ successSummary }}
              </p>
            </div>
            <div
              class="flex items-center justify-center gap-2 bg-orange-900/30 p-2 rounded-lg w-fit mx-auto border border-orange-700"
            >
              <i class="fas fa-fire text-orange-500"></i>
              <span class="text-sm text-orange-300"
                >Серия: {{ streakDays }} дней</span
              >
            </div>
            <!-- Netzach Progress Indicator -->
            <div
              class="bg-gray-800 p-3 rounded-xl text-gray-300 text-sm border border-gray-700"
            >
              <p>
                Прогресс Нецаха: {{ sefirotProgress.netzach.displayProgress }}%
                ({{ sefirotProgress.netzach.dailyActions }}/{{
                  sefirotProgress.netzach.maxActions
                }}
                действий)
              </p>
              <div class="w-48 mx-auto bg-gray-700 rounded-full h-1.5 mt-2">
                <div
                  class="h-1.5 rounded-full bg-gradient-to-r from-yellow-600 to-yellow-400"
                  :style="{
                    width: `${sefirotProgress.netzach.displayProgress}%`,
                  }"
                ></div>
              </div>
              <p class="mt-2">
                Очки: {{ sefirotProgress.netzach.points }} | Уровень:
                {{ sefirotProgress.netzach.level }}
              </p>
            </div>
            <!-- Chesed Progress Indicator -->
            <div
              class="bg-gray-800 p-3 rounded-xl text-gray-300 text-sm border border-gray-700"
            >
              <p>
                Прогресс Хеседа: {{ sefirotProgress.chesed.displayProgress }}%
                ({{ sefirotProgress.chesed.dailyActions }}/{{
                  sefirotProgress.chesed.maxActions
                }}
                действий)
              </p>
              <div class="w-48 mx-auto bg-gray-700 rounded-full h-1.5 mt-2">
                <div
                  class="h-1.5 rounded-full bg-gradient-to-r from-purple-600 to-purple-400"
                  :style="{
                    width: `${sefirotProgress.chesed.displayProgress}%`,
                  }"
                ></div>
              </div>
              <p class="mt-2">
                Очки: {{ sefirotProgress.chesed.points }} | Уровень:
                {{ sefirotProgress.chesed.level }}
              </p>
            </div>
            <button
              @click="closeModal"
              class="bg-blue-600 text-gray-100 px-4 py-2 rounded-lg font-medium hover:bg-blue-500 transition-all hover:-translate-y-1 text-sm"
            >
              Завершить
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirmation Dialog -->
    <div
      v-if="showConfirmation"
      class="fixed inset-0 bg-black/80 flex justify-center items-center z-[1000]"
      @click="cancelClose"
    >
      <div
        class="bg-gray-900 p-5 rounded-xl w-[90%] max-w-[300px] text-center border border-gray-700"
        @click.stop
      >
        <h3 class="text-base font-medium text-gray-100">Вы уверены?</h3>
        <p class="mt-2 text-sm text-gray-300">
          Ваш прогресс будет потерян, если вы выйдете сейчас.
        </p>
        <div class="flex justify-center gap-3 mt-4">
          <button
            @click="cancelClose"
            class="bg-gray-700 text-gray-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-600 transition-all text-sm"
          >
            Отмена
          </button>
          <button
            @click="closeModal"
            class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-500 transition-all text-sm"
          >
            Выйти
          </button>
        </div>
      </div>
    </div>

    <Notification
      v-if="notificationMessage"
      :message="notificationMessage"
      :type="notificationType"
      @close="hideNotification"
      class="z-50"
    />
  </Teleport>
</template>

<script setup>
import { ref, computed, onMounted } from "vue";
import { getAuth, onAuthStateChanged } from "firebase/auth";
import { getFirestore, doc, getDoc, onSnapshot } from "firebase/firestore";
import {
  getDailyGrowthSparkData,
  saveDailyGrowthSparkEntry,
} from "~/api/firebase/dailyGrowthSpark";
import { useNotification } from "@/composables/useNotification";
import Notification from "~/components/base/Notification.vue";

// Authentication and Firestore
const auth = getAuth();
const db = getFirestore();
const user = ref(null);

// Notification handling
const {
  notificationMessage,
  notificationType,
  showNotification,
  hideNotification,
} = useNotification();

// Modal visibility
const isVisible = ref(false);
const showConfirmation = ref(false);

// Stage control
const currentStage = ref("emotion"); // 'emotion', 'energy', 'tip', 'success'

// Progress calculation
const getStageIndex = (stage) => {
  const stages = ["emotion", "energy", "tip", "success"];
  return stages.indexOf(stage);
};

const progressPercentage = computed(() => {
  const currentIndex = getStageIndex(currentStage.value);
  const totalStages = 3; // Excluding success stage
  return Math.min(100, (currentIndex / totalStages) * 100);
});

// Streak and points tracking (for Daily Growth Spark)
const streakDays = ref(0);
const points = ref(0);

// State for Sefirot progress (Netzach and Chesed)
const sefirotProgress = ref({
  netzach: {
    dailyActions: 0,
    maxActions: 3,
    points: 0,
    level: 1,
    displayProgress: 0,
  },
  chesed: {
    dailyActions: 0,
    maxActions: 3,
    points: 0,
    level: 1,
    displayProgress: 0,
  },
});

// Calculate daily progress
const calculateDailyProgress = (actions, maxActions) => {
  return Math.round((actions / maxActions) * 100);
};

// Calculate level based on points
const calculateLevel = (points) => {
  if (points < 200) return 1;
  if (points < 400) return 2;
  if (points < 1000) return 3;
  if (points < 2000) return 4;
  return 5;
};

// Fetch progress for Netzach and Chesed
const fetchSefirotProgress = async (userId) => {
  try {
    // Fetch progress data
    const progressRef = doc(db, `users/${userId}/progress/sefirot`);
    const progressSnap = await getDoc(progressRef);

    if (progressSnap.exists()) {
      const progressData = progressSnap.data();
      if (progressData.netzach) {
        sefirotProgress.value.netzach.points = progressData.netzach.points || 0;
        sefirotProgress.value.netzach.level = calculateLevel(
          sefirotProgress.value.netzach.points
        );
      }
      if (progressData.chesed) {
        sefirotProgress.value.chesed.points = progressData.chesed.points || 0;
        sefirotProgress.value.chesed.level = calculateLevel(
          sefirotProgress.value.chesed.points
        );
      }
    }

    // Fetch daily actions
    const today = new Date().toISOString().split("T")[0];
    const dailyRef = doc(db, `users/${userId}/daily/${today}`);
    const dailySnap = await getDoc(dailyRef);

    if (dailySnap.exists()) {
      const dailyData = dailySnap.data();
      sefirotProgress.value.netzach.dailyActions =
        dailyData.netzach?.actions || 0;
      sefirotProgress.value.netzach.displayProgress = calculateDailyProgress(
        sefirotProgress.value.netzach.dailyActions,
        sefirotProgress.value.netzach.maxActions
      );
      sefirotProgress.value.chesed.dailyActions =
        dailyData.chesed?.actions || 0;
      sefirotProgress.value.chesed.displayProgress = calculateDailyProgress(
        sefirotProgress.value.chesed.dailyActions,
        sefirotProgress.value.chesed.maxActions
      );
    }

    // Set up real-time listeners
    onSnapshot(progressRef, (snap) => {
      if (snap.exists()) {
        const progressData = snap.data();
        if (progressData.netzach) {
          sefirotProgress.value.netzach.points =
            progressData.netzach.points || 0;
          sefirotProgress.value.netzach.level = calculateLevel(
            sefirotProgress.value.netzach.points
          );
        }
        if (progressData.chesed) {
          sefirotProgress.value.chesed.points = progressData.chesed.points || 0;
          sefirotProgress.value.chesed.level = calculateLevel(
            sefirotProgress.value.chesed.points
          );
        }
      }
    });

    onSnapshot(dailyRef, (snap) => {
      if (snap.exists()) {
        const dailyData = snap.data();
        sefirotProgress.value.netzach.dailyActions =
          dailyData.netzach?.actions || 0;
        sefirotProgress.value.netzach.displayProgress = calculateDailyProgress(
          sefirotProgress.value.netzach.dailyActions,
          sefirotProgress.value.netzach.maxActions
        );
        sefirotProgress.value.chesed.dailyActions =
          dailyData.chesed?.actions || 0;
        sefirotProgress.value.chesed.displayProgress = calculateDailyProgress(
          sefirotProgress.value.chesed.dailyActions,
          sefirotProgress.value.chesed.maxActions
        );
      } else {
        sefirotProgress.value.netzach.dailyActions = 0;
        sefirotProgress.value.netzach.displayProgress = 0;
        sefirotProgress.value.chesed.dailyActions = 0;
        sefirotProgress.value.chesed.displayProgress = 0;
      }
    });
  } catch (error) {
    console.error("Error fetching Sefirot progress:", error);
    showNotification("Ошибка загрузки прогресса Сфирот.", "error");
  }
};

// Check auth state and fetch data
onMounted(async () => {
  onAuthStateChanged(auth, async (currentUser) => {
    if (currentUser) {
      user.value = currentUser;
      const response = await getDailyGrowthSparkData(db, currentUser.uid);
      if (response.success) {
        streakDays.value = response.data.streakDays;
        points.value = response.data.points;
        const lastUpdated = response.data.lastUpdated;
        const today = new Date().toISOString().split("T")[0];
        if (lastUpdated !== today) {
          isVisible.value = true;
        }
      }
      await fetchSefirotProgress(currentUser.uid);
    } else {
      user.value = null;
      isVisible.value = false;
      sefirotProgress.value = {
        netzach: {
          dailyActions: 0,
          maxActions: 3,
          points: 0,
          level: 1,
          displayProgress: 0,
        },
        chesed: {
          dailyActions: 0,
          maxActions: 3,
          points: 0,
          level: 1,
          displayProgress: 0,
        },
      };
    }
  });
});

// Emotion Insight Game Logic
const emotionScenarios = [
  {
    sefira: "Бина (Понимание)",
    sefiraDescription: "Глубина чувств и эмоциональная осознанность",
    prompt: "После глубокого разговора с близким человеком вы чувствуете...",
    emotions: [
      { emoji: "🤲", label: "Связь" },
      { emoji: "🌊", label: "Переполненность" },
      { emoji: "🧩", label: "Ясность" },
    ],
    correctIndex: 0,
    tip: "Бина помогает нам обрабатывать сложные эмоции. Заметьте, как этот разговор изменил ваше состояние.",
  },
  {
    sefira: "Нецах (Настойчивость)",
    sefiraDescription: "Мотивация и ежедневные победы",
    prompt:
      "Вы завершили важную задачу, которую откладывали. Какое чувство преобладает?",
    emotions: [
      { emoji: "🏆", label: "Достижение" },
      { emoji: "😮‍💨", label: "Облегчение" },
      { emoji: "🔄", label: "Незавершённость" },
    ],
    correctIndex: 0,
    tip: "Нецах питается нашими маленькими победами. Отмечайте их для поддержания мотивации.",
  },
  {
    sefira: "Хесед (Милосердие)",
    sefiraDescription: "Щедрость и связь с другими",
    prompt: "Кто-то поблагодарил вас за помощь. Ваша реакция:",
    emotions: [
      { emoji: "💞", label: "Со-радость" },
      { emoji: "🤷", label: "Безразличие" },
      { emoji: "😳", label: "Смущение" },
    ],
    correctIndex: 0,
    tip: "Хесед учит нас принимать благодарность так же открыто, как мы даём помощь.",
  },
  {
    sefira: "Гвура (Сила)",
    sefiraDescription: "Границы и дисциплина",
    prompt: "Вам нужно сказать 'нет' ради своих границ. Вы чувствуете:",
    emotions: [
      { emoji: "🛡️", label: "Уверенность" },
      { emoji: "⚖️", label: "Вину" },
      { emoji: "🌪️", label: "Смятение" },
    ],
    correctIndex: 0,
    tip: "Гвура напоминает: здоровые границы — акт заботы, а не агрессии.",
  },
];

const currentSetIndex = ref(
  Math.floor(Math.random() * emotionScenarios.length)
);
const currentScenario = computed(() => emotionScenarios[currentSetIndex.value]);
const correctIndex = computed(
  () => emotionScenarios[currentSetIndex.value].correctIndex
);

const selectedIndex = ref(null);
const isCorrect = ref(false);
const isWrong = ref(false);
const feedback = ref("");
const gameComplete = ref(false);
const winCount = ref(0);

const handleEmotionClick = (index) => {
  if (selectedIndex.value !== null || gameComplete.value) return;
  selectedIndex.value = index;

  if (index === correctIndex.value) {
    isCorrect.value = true;
    feedback.value = `Правильно! Это развивает ${currentScenario.value.sefira}. ${currentScenario.value.tip}`;
    winCount.value += 1;
    points.value += 10;

    // Update Sefirot progress based on current scenario
    if (currentScenario.value.sefira.includes("Нецах")) {
      sefirotProgress.value.netzach.dailyActions += 1;
      sefirotProgress.value.netzach.points += 10;
    } else if (currentScenario.value.sefira.includes("Хесед")) {
      sefirotProgress.value.chesed.dailyActions += 1;
      sefirotProgress.value.chesed.points += 10;
    }

    gameComplete.value = true;
  } else {
    isWrong.value = true;
    feedback.value =
      "Попробуйте снова. Обратите внимание на подсказку о " +
      currentScenario.value.sefira;
    setTimeout(() => {
      gameComplete.value = true;
    }, 1000);
  }
};

const nextRound = () => {
  if (winCount.value >= 3) {
    currentStage.value = "energy";
    feedback.value = "";
    return;
  }

  let newIndex;
  do {
    newIndex = Math.floor(Math.random() * emotionScenarios.length);
  } while (newIndex === currentSetIndex.value);
  currentSetIndex.value = newIndex;

  selectedIndex.value = null;
  isCorrect.value = false;
  isWrong.value = false;
  feedback.value = "";
  gameComplete.value = false;
};

// Energy level logic
const energyLevel = ref(5);
const energyFeedback = computed(() => {
  if (energyLevel.value <= 3) return "День с низкой энергией";
  if (energyLevel.value <= 7) return "Стабильная энергия";
  return "Пик высокой энергии";
});

const energyEmoji = computed(() => {
  if (energyLevel.value <= 2) return "😴";
  if (energyLevel.value <= 4) return "😌";
  if (energyLevel.value <= 6) return "😊";
  if (energyLevel.value <= 8) return "😃";
  return "🤩";
});

// Growth Fuel items with FontAwesome icons
const growthFuelItems = ref([
  { icon: "fa-tint", label: "Пить воду", selected: false },
  { icon: "fa-running", label: "Размяться", selected: false },
  { icon: "fa-apple-alt", label: "Здоровая еда", selected: false },
  { icon: "fa-om", label: "Медитация", selected: false },
  { icon: "fa-book", label: "Учиться", selected: false },
]);

const toggleFuelItem = (index) => {
  growthFuelItems.value[index].selected =
    !growthFuelItems.value[index].selected;
};

const submitEnergy = () => {
  points.value += 5; // Bonus for completing energy stage
  energyLevel.value = Number(energyLevel.value);
  currentStage.value = "tip";
};

// Tip input logic
const tip = ref("");
const isAnonymous = ref(false);
const tipCategories = ref([
  "Работа",
  "Здоровье",
  "Осознанность",
  "Отношения",
  "Обучение",
]);
const selectedCategory = ref("Осознанность");

// Modified submitTip with Netzach and Chesed feedback
const submitTip = async () => {
  const oldNetzachLevel = sefirotProgress.value.netzach.level;
  const oldChesedLevel = sefirotProgress.value.chesed.level;
  points.value += 20;
  const growthData = {
    gameResults: { wins: winCount.value },
    energy: {
      level: Number(energyLevel.value),
      fuelFactors: growthFuelItems.value
        .filter((item) => item.selected)
        .map((item) => item.label),
    },
    insight: {
      text: tip.value,
      category: selectedCategory.value,
      isAnonymous: isAnonymous.value,
      displayName: user.value.displayName,
    },
    points: points.value,
  };

  const response = await saveDailyGrowthSparkEntry(
    db,
    user.value.uid,
    growthData,
    showNotification
  );
  if (response.success) {
    streakDays.value = response.streakDays;
    points.value = response.points;
    currentStage.value = "success";
    // Show Netzach and Chesed progress feedback
    showNotification(
      `Запись сохранена! Вы заработали 10 очков для Нецаха (прогресс: ${sefirotProgress.value.netzach.displayProgress}%) и 10 очков для Хеседа (прогресс: ${sefirotProgress.value.chesed.displayProgress}%).`,
      "success"
    );
    // Check for level-ups
    if (sefirotProgress.value.netzach.level > oldNetzachLevel) {
      showNotification(
        `Поздравляем! Вы достигли уровня ${sefirotProgress.value.netzach.level} для Нецаха!`,
        "success"
      );
    }
    if (sefirotProgress.value.chesed.level > oldChesedLevel) {
      showNotification(
        `Поздравляем! Вы достигли уровня ${sefirotProgress.value.chesed.level} для Хеседа!`,
        "success"
      );
    }
  }
};

// Modified skipTip with Netzach feedback only
const skipTip = async () => {
  const oldNetzachLevel = sefirotProgress.value.netzach.level;
  const growthData = {
    gameResults: { wins: winCount.value },
    energy: {
      level: Number(energyLevel.value),
      fuelFactors: growthFuelItems.value
        .filter((item) => item.selected)
        .map((item) => item.label),
    },
    insight: null,
    points: points.value,
  };

  const response = await saveDailyGrowthSparkEntry(
    db,
    user.value.uid,
    growthData,
    showNotification
  );
  if (response.success) {
    streakDays.value = response.streakDays;
    points.value = response.points;
    currentStage.value = "success";
    // Show Netzach progress feedback
    showNotification(
      `Запись сохранена! Вы заработали 10 очков для Нецаха. Текущий прогресс: ${sefirotProgress.value.netzach.displayProgress}% (${sefirotProgress.value.netzach.dailyActions}/${sefirotProgress.value.netzach.maxActions} действий).`,
      "success"
    );
    // Check for level-up
    if (sefirotProgress.value.netzach.level > oldNetzachLevel) {
      showNotification(
        `Поздравляем! Вы достигли уровня ${sefirotProgress.value.netzach.level} для Нецаха!`,
        "success"
      );
    }
  }
};

// Success summary
const successSummary = computed(() => {
  const emotion =
    emotionScenarios[currentSetIndex.value].emotions[
      correctIndex.value
    ].label.toLowerCase();
  const fuel =
    growthFuelItems.value
      .filter((item) => item.selected)
      .map((item) => item.label.toLowerCase())
      .join(", ") || "ничего не выбрано";
  const tipText = tip.value
    ? `поделились советом в категории "${selectedCategory.value}"`
    : "пропустили совет";
  return `чувствовали ${emotion}, имели ${energyFeedback.value.toLowerCase()}, выбрали топливо: ${fuel}, и ${tipText}.`;
});

// Modal control
const handleOverlayClick = (event) => {
  if (event.target.classList.contains("fixed")) confirmClose();
};

const confirmClose = () => {
  showConfirmation.value = true;
};

const cancelClose = () => {
  showConfirmation.value = false;
};

const closeModal = () => {
  isVisible.value = false;
  showConfirmation.value = false;
};
</script>

<style scoped>
input[type="range"]::-webkit-slider-thumb {
  appearance: none;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: white;
  border: 2px solid #3b82f6;
  cursor: pointer;
  transition: all 0.2s;
}

input[type="range"]::-webkit-slider-thumb:hover {
  transform: scale(1.2);
}

@keyframes fade-in-up {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes bounce-in {
  0% {
    transform: scale(0.3);
    opacity: 0;
  }
  50% {
    transform: scale(1.1);
    opacity: 1;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

@keyframes shake {
  0% {
    transform: translateX(0);
  }
  20% {
    transform: translateX(-8px) rotate(-5deg);
  }
  40% {
    transform: translateX(8px) rotate(5deg);
  }
  60% {
    transform: translateX(-4px) rotate(-3deg);
  }
  80% {
    transform: translateX(4px) rotate(3deg);
  }
  100% {
    transform: translateX(0);
  }
}

.animate-fade-in-up {
  animation: fade-in-up 0.3s ease-out;
}

.animate-bounce-in {
  animation: bounce-in 0.6s;
}

.animate-shake {
  animation: shake 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
}
</style>
