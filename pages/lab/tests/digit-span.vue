<template>
  <div
    class="digit-span-test min-h-screen bg-slate-950 px-4 sm:px-6 lg:px-8 py-8"
  >
    <div class="max-w-4xl mx-auto">
      <!-- Intro Screen -->
      <div v-if="phase === 'intro'" class="text-center">
        <div class="mb-8">
          <div class="inline-block relative">
            <div
              class="w-24 h-24 rounded-2xl bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center mb-6 animate-pulse-slow"
            >
              <i class="fas fa-brain text-white text-5xl"></i>
            </div>
            <div
              class="absolute -top-2 -right-2 w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center"
            >
              <i class="fas fa-check text-white text-sm"></i>
            </div>
          </div>
        </div>

        <h1
          class="text-4xl sm:text-5xl lg:text-6xl font-bold text-white mb-4 tracking-tight gradient-text"
        >
          –¢–ï–°–¢ –û–ë–™–ï–ú–ê –ü–ê–ú–Ø–¢–ò
        </h1>
        <p
          class="text-cyan-300/80 text-lg sm:text-xl leading-relaxed max-w-2xl mx-auto mb-8"
        >
          Digit Span Test ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç —Ä–∞–±–æ—á–µ–π –ø–∞–º—è—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –≤
          –Ω–µ–π—Ä–æ–ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏ –∏ –æ—Ü–µ–Ω–∫–µ IQ
        </p>

        <div class="grid md:grid-cols-3 gap-6 mb-12 max-w-3xl mx-auto">
          <div class="info-card-small">
            <div
              class="w-12 h-12 rounded-xl bg-cyan-500/20 flex items-center justify-center mb-3 mx-auto"
            >
              <i class="fas fa-clock text-cyan-400 text-xl"></i>
            </div>
            <div class="text-2xl font-bold text-cyan-400 mb-1">5-8 –º–∏–Ω</div>
            <div class="text-sm text-slate-400">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
          </div>
          <div class="info-card-small">
            <div
              class="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center mb-3 mx-auto"
            >
              <i class="fas fa-layer-group text-purple-400 text-xl"></i>
            </div>
            <div class="text-2xl font-bold text-purple-400 mb-1">2 —ç—Ç–∞–ø–∞</div>
            <div class="text-sm text-slate-400">–ü—Ä—è–º–æ–π + –û–±—Ä–∞—Ç–Ω—ã–π</div>
          </div>
          <div class="info-card-small">
            <div
              class="w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center mb-3 mx-auto"
            >
              <i class="fas fa-chart-line text-emerald-400 text-xl"></i>
            </div>
            <div class="text-2xl font-bold text-emerald-400 mb-1">–ù–∞—É—á–Ω–æ</div>
            <div class="text-sm text-slate-400">–í–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω</div>
          </div>
        </div>

        <div class="info-card max-w-2xl mx-auto mb-8">
          <div class="flex items-start gap-4">
            <div
              class="w-10 h-10 rounded-lg bg-cyan-500/20 flex items-center justify-center flex-shrink-0"
            >
              <i class="fas fa-info-circle text-cyan-400"></i>
            </div>
            <div class="text-left">
              <h3 class="text-lg font-semibold text-white mb-2">
                –ß—Ç–æ –∏–∑–º–µ—Ä—è–µ—Ç —ç—Ç–æ—Ç —Ç–µ—Å—Ç?
              </h3>
              <p class="text-slate-300 text-sm leading-relaxed">
                Digit Span Test –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –æ–±—ä–µ–º –≤–∞—à–µ–π
                <strong class="text-cyan-400">—Ä–∞–±–æ—á–µ–π –ø–∞–º—è—Ç–∏</strong> ‚Äî
                —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ –º–∞–Ω–∏–ø—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.
                –≠—Ç–æ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –∫–æ—Ä—Ä–µ–ª–∏—Ä—É–µ—Ç —Å –æ–±—â–∏–º–∏ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è–º–∏
                –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ç–µ—Å—Ç–∞—Ö IQ (WAIS, Wechsler).
              </p>
            </div>
          </div>
        </div>

        <button
          @click="phase = 'instructions'"
          class="btn-primary text-lg px-10 py-5"
        >
          <i class="fas fa-play mr-2"></i>
          –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç
          <i class="fas fa-arrow-right ml-2"></i>
        </button>
      </div>

      <!-- Instructions Screen -->
      <div v-if="phase === 'instructions'" class="max-w-2xl mx-auto">
        <div class="text-center mb-8">
          <h2 class="text-3xl font-bold text-white mb-4 gradient-text">
            –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
          </h2>
          <p class="text-slate-300">–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–π—Ç–µ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º</p>
        </div>

        <div class="space-y-6 mb-8">
          <div class="instruction-card">
            <div class="flex items-start gap-4">
              <div
                class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center flex-shrink-0"
              >
                <span class="text-white font-bold">1</span>
              </div>
              <div class="text-left flex-1">
                <h3 class="text-lg font-semibold text-white mb-2">
                  –ó–∞–ø–æ–º–∏–Ω–∞–π—Ç–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                </h3>
                <p class="text-slate-300 text-sm leading-relaxed">
                  –ù–∞ —ç–∫—Ä–∞–Ω–µ –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è —Ü–∏—Ñ—Ä—ã –ø–æ –æ–¥–Ω–æ–π. –ü–æ—Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å
                  –∑–∞–ø–æ–º–Ω–∏—Ç—å –∏—Ö –ø–æ—Ä—è–¥–æ–∫.
                </p>
              </div>
            </div>
          </div>

          <div class="instruction-card">
            <div class="flex items-start gap-4">
              <div
                class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center flex-shrink-0"
              >
                <span class="text-white font-bold">2</span>
              </div>
              <div class="text-left flex-1">
                <h3 class="text-lg font-semibold text-white mb-2">
                  –î–≤–∞ —Ä–µ–∂–∏–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                </h3>
                <p class="text-slate-300 text-sm leading-relaxed mb-3">
                  <strong class="text-cyan-400">–ü—Ä—è–º–æ–π –ø–æ—Ä—è–¥–æ–∫:</strong> –í–≤–æ–¥–∏—Ç–µ
                  —Ü–∏—Ñ—Ä—ã –≤ —Ç–æ–º –∂–µ –ø–æ—Ä—è–¥–∫–µ, –∫–∞–∫ –æ–Ω–∏ –ø–æ—è–≤–∏–ª–∏—Å—å<br />
                  <strong class="text-purple-400">–û–±—Ä–∞—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫:</strong>
                  –í–≤–æ–¥–∏—Ç–µ —Ü–∏—Ñ—Ä—ã –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                </p>
                <div class="bg-slate-800/50 p-3 rounded-lg">
                  <div class="text-xs text-slate-400 mb-1">
                    –ü—Ä–∏–º–µ—Ä (–æ–±—Ä–∞—Ç–Ω—ã–π):
                  </div>
                  <div class="text-sm text-white">
                    –ü–æ–∫–∞–∑–∞–ª–∏: <span class="text-cyan-400">3 ‚Üí 7 ‚Üí 2</span>
                  </div>
                  <div class="text-sm text-white">
                    –í—ã –≤–≤–æ–¥–∏—Ç–µ: <span class="text-purple-400">2 ‚Üí 7 ‚Üí 3</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="instruction-card">
            <div class="flex items-start gap-4">
              <div
                class="w-10 h-10 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center flex-shrink-0"
              >
                <span class="text-white font-bold">3</span>
              </div>
              <div class="text-left flex-1">
                <h3 class="text-lg font-semibold text-white mb-2">
                  –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å
                </h3>
                <p class="text-slate-300 text-sm leading-relaxed">
                  –¢–µ—Å—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 3 —Ü–∏—Ñ—Ä –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–ª–æ–∂–Ω–µ–µ. –£ –≤–∞—Å –µ—Å—Ç—å 2
                  –ø–æ–ø—ã—Ç–∫–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ. –¢–µ—Å—Ç –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –¥–≤—É—Ö –æ—à–∏–±–æ–∫
                  –ø–æ–¥—Ä—è–¥.
                </p>
              </div>
            </div>
          </div>
        </div>

        <div
          class="bg-gradient-to-r from-cyan-500/10 to-purple-500/10 border border-cyan-500/20 rounded-2xl p-6 mb-8"
        >
          <div class="flex items-start gap-3">
            <i class="fas fa-lightbulb text-yellow-400 text-xl mt-1"></i>
            <div>
              <h4 class="text-white font-semibold mb-1">–°–æ–≤–µ—Ç</h4>
              <p class="text-slate-300 text-sm">
                –ü—Ä–æ—Ö–æ–¥–∏—Ç–µ —Ç–µ—Å—Ç –≤ —Ç–∏—Ö–æ–º –º–µ—Å—Ç–µ, –∫–æ–≥–¥–∞ –≤—ã –æ—Ç–¥–æ—Ö–Ω—É–≤—à–∏ –∏
                —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–µ–Ω—ã. –≠—Ç–æ –¥–∞—Å—Ç –Ω–∞–∏–±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.
              </p>
            </div>
          </div>
        </div>

        <div class="flex gap-4 justify-center">
          <button @click="phase = 'intro'" class="btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>
            –ù–∞–∑–∞–¥
          </button>
          <button @click="startTest" class="btn-primary text-lg px-8">
            –ü–æ–Ω—è—Ç–Ω–æ, –Ω–∞—á–∏–Ω–∞–µ–º!
            <i class="fas fa-arrow-right ml-2"></i>
          </button>
        </div>
      </div>

      <!-- Test Screen -->
      <div v-if="phase === 'test'" class="max-w-3xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
          <div
            class="inline-flex items-center gap-3 px-6 py-3 bg-slate-900/60 border border-cyan-500/20 rounded-xl mb-4"
          >
            <div
              :class="
                testMode === 'forward' ? 'text-cyan-400' : 'text-purple-400'
              "
            >
              <i
                :class="
                  testMode === 'forward'
                    ? 'fas fa-arrow-right'
                    : 'fas fa-arrow-left'
                "
                class="mr-2"
              ></i>
              {{
                testMode === "forward" ? "–ü–†–Ø–ú–û–ô –ü–û–†–Ø–î–û–ö" : "–û–ë–†–ê–¢–ù–´–ô –ü–û–†–Ø–î–û–ö"
              }}
            </div>
            <span class="text-slate-600">‚Ä¢</span>
            <div class="text-slate-300">
              –£—Ä–æ–≤–µ–Ω—å:
              <span class="font-bold text-white">{{ currentLevel }}</span>
            </div>
            <span class="text-slate-600">‚Ä¢</span>
            <div class="text-slate-300">
              –ü–æ–ø—ã—Ç–∫–∞:
              <span class="font-bold text-white"
                >{{ attempts.current + 1 }}/{{ attempts.max }}</span
              >
            </div>
          </div>
        </div>

        <!-- Display Area -->
        <div class="mb-12">
          <!-- Showing Sequence -->
          <div v-if="showingSequence" class="text-center">
            <div class="mb-8">
              <div class="text-slate-400 text-sm mb-4 uppercase tracking-wide">
                –ó–∞–ø–æ–º–∏–Ω–∞–π—Ç–µ...
              </div>
              <div class="digit-display">
                {{ sequence[displayIndex] }}
              </div>
            </div>
            <div class="flex justify-center gap-2">
              <div
                v-for="(_, index) in sequence"
                :key="index"
                class="w-3 h-3 rounded-full transition-all duration-300"
                :class="
                  index === displayIndex
                    ? 'bg-cyan-400 scale-125'
                    : index < displayIndex
                    ? 'bg-cyan-400/30'
                    : 'bg-slate-700'
                "
              ></div>
            </div>
          </div>

          <!-- Input Phase -->
          <div v-else class="text-center">
            <div class="mb-6">
              <div class="text-slate-400 text-sm mb-4 uppercase tracking-wide">
                {{
                  testMode === "forward"
                    ? "–í–≤–µ–¥–∏—Ç–µ —Ü–∏—Ñ—Ä—ã –≤ –ø—Ä—è–º–æ–º –ø–æ—Ä—è–¥–∫–µ"
                    : "–í–≤–µ–¥–∏—Ç–µ —Ü–∏—Ñ—Ä—ã –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ"
                }}
              </div>
              <input
                ref="inputRef"
                v-model="userInput"
                type="text"
                inputmode="numeric"
                pattern="[0-9]*"
                maxlength="20"
                class="digit-input"
                :placeholder="'_ '.repeat(currentLevel).trim()"
                @keyup.enter="submitAnswer"
                autofocus
              />
              <div class="mt-4 text-slate-500 text-xs">
                –í–≤–µ–¥–∏—Ç–µ {{ currentLevel }}
                {{
                  currentLevel === 1
                    ? "—Ü–∏—Ñ—Ä—É"
                    : currentLevel < 5
                    ? "—Ü–∏—Ñ—Ä—ã"
                    : "—Ü–∏—Ñ—Ä"
                }}
                –∏ –Ω–∞–∂–º–∏—Ç–µ Enter –∏–ª–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ
              </div>
            </div>

            <button
              @click="submitAnswer"
              class="btn-primary"
              :disabled="userInput.length !== currentLevel"
            >
              <i class="fas fa-check mr-2"></i>
              –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç
            </button>
          </div>
        </div>

        <!-- Progress Indicator -->
        <div class="info-card">
          <div class="flex items-center justify-between text-sm">
            <div class="text-slate-400">–í–∞—à —Ç–µ–∫—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</div>
            <div class="flex gap-4">
              <div>
                <span class="text-cyan-400 font-semibold">–ü—Ä—è–º–æ–π:</span>
                <span class="text-white font-bold ml-2">{{
                  results.forward
                }}</span>
              </div>
              <div>
                <span class="text-purple-400 font-semibold">–û–±—Ä–∞—Ç–Ω—ã–π:</span>
                <span class="text-white font-bold ml-2">{{
                  results.backward
                }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Results Screen -->
      <div v-if="phase === 'result'" class="max-w-3xl mx-auto">
        <div class="text-center mb-12">
          <div class="inline-block mb-6">
            <div
              class="w-24 h-24 rounded-2xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center animate-bounce-slow"
            >
              <i class="fas fa-trophy text-white text-5xl"></i>
            </div>
          </div>
          <h2 class="text-4xl font-bold text-white mb-4 gradient-text">
            –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! üéâ
          </h2>
          <p class="text-slate-300 text-lg">
            –í–æ—Ç –≤–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ç–µ—Å—Ç—É –æ–±—ä–µ–º–∞ –ø–∞–º—è—Ç–∏
          </p>
        </div>

        <!-- Main Results -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
          <div class="result-card">
            <div class="flex items-center gap-3 mb-4">
              <div
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center"
              >
                <i class="fas fa-arrow-right text-white text-xl"></i>
              </div>
              <div class="text-left">
                <div class="text-sm text-slate-400">–ü—Ä—è–º–æ–π –ø–æ—Ä—è–¥–æ–∫</div>
                <div class="text-2xl font-bold text-cyan-400">
                  {{ results.forward }} —Ü–∏—Ñ—Ä
                </div>
              </div>
            </div>
            <div class="text-sm text-slate-300 leading-relaxed">
              {{ getForwardInterpretation() }}
            </div>
          </div>

          <div class="result-card">
            <div class="flex items-center gap-3 mb-4">
              <div
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center"
              >
                <i class="fas fa-arrow-left text-white text-xl"></i>
              </div>
              <div class="text-left">
                <div class="text-sm text-slate-400">–û–±—Ä–∞—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</div>
                <div class="text-2xl font-bold text-purple-400">
                  {{ results.backward }} —Ü–∏—Ñ—Ä
                </div>
              </div>
            </div>
            <div class="text-sm text-slate-300 leading-relaxed">
              {{ getBackwardInterpretation() }}
            </div>
          </div>
        </div>

        <!-- Total Score -->
        <div class="mb-8">
          <div class="performance-card">
            <div class="text-center mb-6">
              <div class="text-sm text-slate-400 uppercase tracking-wide mb-2">
                –û–±—â–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å
              </div>
              <div
                class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400"
              >
                {{ totalScore }}
              </div>
              <div class="text-lg text-slate-300 mt-2">
                {{ getTotalRating() }}
              </div>
            </div>
            <div class="relative h-3 bg-slate-800 rounded-full overflow-hidden">
              <div
                class="absolute inset-y-0 left-0 bg-gradient-to-r from-cyan-500 to-purple-500 rounded-full transition-all duration-1000"
                :style="{ width: `${Math.min((totalScore / 20) * 100, 100)}%` }"
              ></div>
            </div>
          </div>
        </div>

        <!-- Interpretation -->
        <div class="info-card mb-8">
          <div class="flex items-start gap-4">
            <div
              class="w-10 h-10 rounded-lg bg-emerald-500/20 flex items-center justify-center flex-shrink-0"
            >
              <i class="fas fa-brain text-emerald-400"></i>
            </div>
            <div class="text-left flex-1">
              <h3 class="text-lg font-semibold text-white mb-3">
                –ß—Ç–æ –æ–∑–Ω–∞—á–∞—é—Ç –≤–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã?
              </h3>
              <div class="space-y-3 text-sm text-slate-300 leading-relaxed">
                <p>
                  <strong class="text-cyan-400">–ü—Ä—è–º–æ–π –ø–æ—Ä—è–¥–æ–∫</strong> –æ—Ç—Ä–∞–∂–∞–µ—Ç
                  –≤–∞—à—É —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–π –ø–∞–º—è—Ç–∏.
                  –°—Ä–µ–¥–Ω–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –≤–∑—Ä–æ—Å–ª–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ ‚Äî 7¬±2 —Ü–∏—Ñ—Ä—ã (–∑–∞–∫–æ–Ω
                  –ú–∏–ª–ª–µ—Ä–∞).
                </p>
                <p>
                  <strong class="text-purple-400">–û–±—Ä–∞—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</strong>
                  —Ç—Ä–µ–±—É–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –Ω–æ –∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π,
                  —á—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏ —Ä–∞–±–æ—á–µ–π
                  –ø–∞–º—è—Ç–∏.
                </p>
                <p>
                  <strong class="text-emerald-400">–û–±—â–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å</strong>
                  –∫–æ—Ä—Ä–µ–ª–∏—Ä—É–µ—Ç —Å –æ–±—â–∏–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –±–∞—Ç–∞—Ä–µ–µ
                  —Ç–µ—Å—Ç–æ–≤ WAIS (—à–∫–∞–ª–∞ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –í–µ–∫—Å–ª–µ—Ä–∞).
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Normative Data -->
        <div class="grid md:grid-cols-3 gap-4 mb-8">
          <div class="stat-comparison">
            <div class="text-xs text-slate-400 mb-2">–°—Ä–µ–¥–Ω–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å</div>
            <div class="text-2xl font-bold text-slate-300">12-14</div>
            <div class="text-xs text-slate-500 mt-1">–û–±—â–∞—è –ø–æ–ø—É–ª—è—Ü–∏—è</div>
          </div>
          <div class="stat-comparison">
            <div class="text-xs text-slate-400 mb-2">–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
            <div class="text-2xl font-bold text-cyan-400">{{ totalScore }}</div>
            <div class="text-xs" :class="getComparisonClass()">
              {{ getComparison() }}
            </div>
          </div>
          <div class="stat-comparison">
            <div class="text-xs text-slate-400 mb-2">–û—Ç–ª–∏—á–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å</div>
            <div class="text-2xl font-bold text-emerald-400">16+</div>
            <div class="text-xs text-slate-500 mt-1">–¢–æ–ø 10%</div>
          </div>
        </div>

        <!-- Recommendations -->
        <div class="info-card mb-8">
          <div class="flex items-start gap-4">
            <div
              class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center flex-shrink-0"
            >
              <i class="fas fa-lightbulb text-purple-400"></i>
            </div>
            <div class="text-left flex-1">
              <h3 class="text-lg font-semibold text-white mb-3">
                –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è
              </h3>
              <ul class="space-y-2 text-sm text-slate-300">
                <li class="flex items-start gap-2">
                  <i class="fas fa-check text-cyan-400 mt-1 text-xs"></i>
                  <span
                    >–¢—Ä–µ–Ω–∏—Ä—É–π—Ç–µ —Ä–∞–±–æ—á—É—é –ø–∞–º—è—Ç—å —Å –ø–æ–º–æ—â—å—é N-back —Ç–µ—Å—Ç–æ–≤ –∏
                    –≥–æ–ª–æ–≤–æ–ª–æ–º–æ–∫</span
                  >
                </li>
                <li class="flex items-start gap-2">
                  <i class="fas fa-check text-cyan-400 mt-1 text-xs"></i>
                  <span
                    >–ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –º–Ω–µ–º–æ–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏ (–º–µ—Ç–æ–¥ –ª–æ–∫—É—Å–æ–≤,
                    –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏)</span
                  >
                </li>
                <li class="flex items-start gap-2">
                  <i class="fas fa-check text-cyan-400 mt-1 text-xs"></i>
                  <span
                    >–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –∞—ç—Ä–æ–±–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —É–ª—É—á—à–∞—é—Ç –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ
                    —Ñ—É–Ω–∫—Ü–∏–∏</span
                  >
                </li>
                <li class="flex items-start gap-2">
                  <i class="fas fa-check text-cyan-400 mt-1 text-xs"></i>
                  <span
                    >–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–æ–Ω –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏–∏
                    –ø–∞–º—è—Ç–∏</span
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <button @click="restartTest" class="btn-primary px-8 py-4 text-lg">
            <i class="fas fa-redo mr-2"></i>
            –ü—Ä–æ–π—Ç–∏ —Å–Ω–æ–≤–∞
          </button>
          <button @click="shareResults" class="btn-secondary px-8 py-4 text-lg">
            <i class="fas fa-share mr-2"></i>
            –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
          </button>
          <NuxtLink
            to="/lab/tests"
            class="btn-secondary px-8 py-4 text-lg text-center inline-flex items-center justify-center"
          >
            <i class="fas fa-arrow-left mr-2"></i>
            –ö —Ç–µ—Å—Ç–∞–º
          </NuxtLink>
        </div>
      </div>
    </div>
  </div>
</template>
<script setup>
import { ref, computed, nextTick } from "vue";

definePageMeta({
  layout: "laboratory",
});

const phase = ref("intro"); // intro, instructions, test, result
const testMode = ref("forward"); // forward, backward
const currentLevel = ref(3);
const sequence = ref([]);
const displayIndex = ref(0);
const userInput = ref("");
const showingSequence = ref(false);
const results = ref({ forward: 0, backward: 0 });
const attempts = ref({ current: 0, max: 2 });
const inputRef = ref(null);

const totalScore = computed(
  () => results.value.forward + results.value.backward
);

const generateSequence = (length) => {
  const seq = [];
  for (let i = 0; i < length; i++) {
    seq.push(Math.floor(Math.random() * 9) + 1);
  }
  return seq;
};

const startTest = () => {
  phase.value = "test";
  testMode.value = "forward";
  currentLevel.value = 3;
  results.value = { forward: 0, backward: 0 };
  attempts.value = { current: 0, max: 2 };
  showNextSequence();
};

const showNextSequence = async () => {
  sequence.value = generateSequence(currentLevel.value);
  userInput.value = "";
  showingSequence.value = true;
  displayIndex.value = 0;

  // Show digits one by one
  for (let i = 0; i < sequence.value.length; i++) {
    displayIndex.value = i;
    await new Promise((resolve) => setTimeout(resolve, 1000));
  }

  // Wait a bit after last digit
  await new Promise((resolve) => setTimeout(resolve, 500));

  showingSequence.value = false;

  // Focus input
  await nextTick();
  if (inputRef.value) {
    inputRef.value.focus();
  }
};

const submitAnswer = () => {
  if (userInput.value.length !== currentLevel.value) return;

  const userSequence = userInput.value.split("").map(Number);
  const correctSequence =
    testMode.value === "forward"
      ? sequence.value
      : [...sequence.value].reverse();

  const isCorrect =
    JSON.stringify(userSequence) === JSON.stringify(correctSequence);

  if (isCorrect) {
    // Correct answer - move to next level
    if (testMode.value === "forward") {
      results.value.forward = currentLevel.value;
    } else {
      results.value.backward = currentLevel.value;
    }
    currentLevel.value++;
    attempts.value.current = 0;
    showNextSequence();
  } else {
    // Wrong answer
    attempts.value.current++;

    if (attempts.value.current >= attempts.value.max) {
      // Failed twice - move to next mode or end test
      if (testMode.value === "forward") {
        // Switch to backward mode
        testMode.value = "backward";
        currentLevel.value = 3;
        attempts.value.current = 0;
        showNextSequence();
      } else {
        // Test complete
        saveResults();
        phase.value = "result";
      }
    } else {
      // Try again at same level
      showNextSequence();
    }
  }
};

const saveResults = () => {
  const previousResults = JSON.parse(
    localStorage.getItem("digitSpanResults") || "[]"
  );
  const newResult = {
    date: new Date().toISOString(),
    forward: results.value.forward,
    backward: results.value.backward,
    total: totalScore.value,
  };
  previousResults.push(newResult);
  localStorage.setItem("digitSpanResults", JSON.stringify(previousResults));
};

const getForwardInterpretation = () => {
  const score = results.value.forward;
  if (score >= 9)
    return "–í—ã–¥–∞—é—â–∏–π—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –í–∞—à–∞ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è –ø–∞–º—è—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ.";
  if (score >= 7)
    return "–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –í—ã –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Å—Ä–µ–¥–Ω–µ–π –Ω–æ—Ä–º—ã (7¬±2).";
  if (score >= 5) return "–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ï—Å—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è.";
  return "–†–∞–±–æ—á–∞—è –ø–∞–º—è—Ç—å –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ. –†–µ–≥—É–ª—è—Ä–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –ø–æ–º–æ–∂–µ—Ç!";
};

const getBackwardInterpretation = () => {
  const score = results.value.backward;
  if (score >= 8)
    return "–ü—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–æ! –í–∞—à–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ.";
  if (score >= 6)
    return "–û—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ. –í—ã —É–º–µ–µ—Ç–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –º–∞–Ω–∏–ø—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.";
  if (score >= 4) return "–ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ú–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —Å –ø—Ä–∞–∫—Ç–∏–∫–æ–π.";
  return "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç—Ä–µ–±—É—é—Ç —Ä–∞–∑–≤–∏—Ç–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.";
};

const getTotalRating = () => {
  const total = totalScore.value;
  if (total >= 17) return "–í—ã–¥–∞—é—â–∏–π—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç! üèÜ";
  if (total >= 14) return "–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! ‚≠ê";
  if (total >= 11) return "–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! üëç";
  if (total >= 8) return "–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç";
  return "–ï—Å—Ç—å –Ω–∞–¥ —á–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å";
};

const getComparison = () => {
  const total = totalScore.value;
  if (total >= 17) return "üéØ –¢–æ–ø 5%";
  if (total >= 15) return "üéØ –¢–æ–ø 15%";
  if (total >= 13) return "üìä –í—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ";
  if (total >= 11) return "üìä –°—Ä–µ–¥–Ω–∏–π";
  return "üìä –ù–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–≥–æ";
};

const getComparisonClass = () => {
  const total = totalScore.value;
  if (total >= 16) return "text-emerald-400";
  if (total >= 13) return "text-cyan-400";
  if (total >= 10) return "text-yellow-400";
  return "text-orange-400";
};

const restartTest = () => {
  phase.value = "intro";
  testMode.value = "forward";
  currentLevel.value = 3;
  sequence.value = [];
  displayIndex.value = 0;
  userInput.value = "";
  showingSequence.value = false;
  results.value = { forward: 0, backward: 0 };
  attempts.value = { current: 0, max: 2 };
};

const shareResults = () => {
  const text = `üß† –Ø –ø—Ä–æ—à—ë–ª Digit Span Test –≤ MindQ Lab!\n\nüìä –ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:\n‚Ä¢ –ü—Ä—è–º–æ–π –ø–æ—Ä—è–¥–æ–∫: ${results.value.forward} —Ü–∏—Ñ—Ä\n‚Ä¢ –û–±—Ä–∞—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫: ${results.value.backward} —Ü–∏—Ñ—Ä\n‚Ä¢ –û–±—â–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å: ${totalScore.value}\n\n–ü–æ–ø—Ä–æ–±—É–π –∏ —Ç—ã! mindqlab.com`;

  if (navigator.share) {
    navigator
      .share({
        title: "Digit Span Test - MindQ Lab",
        text: text,
        url: window.location.href,
      })
      .catch(() => {});
  } else {
    navigator.clipboard.writeText(text);
    alert("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!");
  }
};
</script>
<style scoped>
.gradient-text {
  background: linear-gradient(135deg, #06b6d4 0%, #a855f7 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.btn-primary {
  @apply inline-flex items-center justify-center px-6 py-3 rounded-xl bg-gradient-to-r from-cyan-500 to-purple-500 
         text-white font-semibold hover:from-cyan-600 hover:to-purple-600 
         transition-all duration-300 transform hover:scale-105 
         shadow-lg shadow-cyan-500/25 hover:shadow-cyan-500/40
         disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none;
}

.btn-secondary {
  @apply inline-flex items-center justify-center px-6 py-3 rounded-xl bg-slate-800/50 border border-slate-600/50 
         text-slate-300 font-semibold hover:bg-slate-700 hover:border-slate-500 
         transition-all duration-300 transform hover:scale-105;
}

.info-card {
  @apply p-6 rounded-2xl bg-slate-900/50 border border-cyan-500/10 backdrop-blur-sm;
}

.info-card-small {
  @apply p-5 rounded-xl bg-slate-900/40 border border-cyan-500/10 text-center;
}

.instruction-card {
  @apply p-5 rounded-xl bg-slate-900/40 border border-cyan-500/10 hover:border-cyan-500/30 transition-all duration-300;
}

.result-card {
  @apply p-6 rounded-2xl bg-slate-900/50 border border-cyan-500/20 hover:border-cyan-500/40 transition-all duration-300;
}

.performance-card {
  @apply p-8 rounded-2xl bg-gradient-to-br from-slate-900/80 to-slate-800/80 border border-cyan-500/30;
}

.stat-comparison {
  @apply p-4 rounded-xl bg-slate-900/40 border border-slate-700/50 text-center;
}

.digit-display {
  @apply text-8xl md:text-9xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400
         animate-pulse-slow;
}

.digit-input {
  @apply w-full max-w-md mx-auto px-6 py-5 text-4xl md:text-5xl font-bold text-center
         bg-slate-900/50 border-2 border-cyan-500/30 rounded-2xl text-white
         focus:outline-none focus:border-cyan-500 focus:ring-4 focus:ring-cyan-500/20
         placeholder-slate-700 transition-all duration-300 tracking-widest;
}

@keyframes bounce-slow {
  0%,
  100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-10px);
  }
}

@keyframes pulse-slow {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

.animate-bounce-slow {
  animation: bounce-slow 2s ease-in-out infinite;
}

.animate-pulse-slow {
  animation: pulse-slow 2s ease-in-out infinite;
}

/* Responsive adjustments */
@media (max-width: 640px) {
  .digit-display {
    @apply text-7xl;
  }

  .digit-input {
    @apply text-3xl px-4 py-4;
  }

  .info-card,
  .result-card,
  .performance-card {
    @apply p-4;
  }
}

/* Remove number input spinners */
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

input[type="number"] {
  -moz-appearance: textfield;
}
</style>
